# Memória Core — Estado Atual e Implementações

> Extraído de `banco-de-memoria.md`. Carregado em **TODAS** as tarefas.
> Consultado pelo **Gestor de Memória** (Agente 02) antes de cada ação.
> Atualizado ao final de cada implementação significativa (Etapa 7 do pipeline).

---

## Estado Atual

| Campo | Valor |
|---|---|
| Projeto | vigiacontratos |
| Tipo | Sistema de gestão contratual municipal |
| Fase Atual | Fase 3a — Contratos — Concluída |
| Última Atualização | 2026-02-20 |
| Próximo Passo | Fase 3b — Documentos (Central de Documentos, upload múltiplo, versionamento, completude documental) |
| Branch Ativa | `homolog` criada em 2026-02-20 — fluxo de branching ativo |
| Fluxo Git | `feature/*` → PR → `homolog` → (validação) → `main` |

### Cadeia de Fases

```
[Fase 0: Setup] → [Fase 1a: Ambiente+MultiTenant] → [Fase 1b: Template+Auth] → [Fase 1c: Migrations Base] → [Fase 2: RBAC Base] → [Fase 3a: Contratos] → [Fase 3b: Documentos] → [Fase 3c: Aditivos+Workflow] → [Fase 4: Alertas] → [Fase 5: Dashboard+Risco] → [Fase 6: Refinamento]
        ✅ concluída       ✅ concluída       ✅ concluída       ✅ concluída     ✅ concluída     ▲ próxima
```

**Detalhamento das Fases:**
- **Fase 0 — Setup Inicial:** Preencher bases de conhecimento, definir stack e convenções
- **Fase 1a — Ambiente + Multi-Tenant:** Laravel 12 via Sail, Docker (MySQL 8 + Redis), banco master (tenants, tenant_users), middleware SetTenantConnection, commands tenant:create e tenant:migrate, configuração S3-compatible
- **Fase 1b — Template + Autenticação:** Integrar WowDash (assets, layout Blade, sidebar, navbar), autenticação (login, logout, forgot password), Argon2id, login logs (LoginLog), lockout após 5 tentativas
- **Fase 1c — Migrations Base:** Tabela users (com role_id FK), secretarias, fornecedores, CRUD base de Secretarias e Fornecedores
- **Fase 2 — RBAC Base:** roles, permissions, role_permissions, user_permissions, user_secretarias, middleware EnsureUserHasPermission, policies, seeder dos 8 perfis, UI de gestão de roles/permissões *(sem workflow de aprovação — movido para Fase 3c)*
- **Fase 3a — Contratos:** Wizard multi-etapa, CRUD completo de Contratos + Fiscais (com histórico de trocas) + Execução Financeira + Score de Risco + Audit Trail (historico_alteracoes)
- **Fase 3b — Documentos (Central de Documentos):** Pasta digital por contrato, 12 tipos de documento, versionamento automático não-destrutivo, completude documental, log de acesso, hash SHA-256, busca inteligente, dashboard de indicadores, relatório TCE
- **Fase 3c — Aditivos + Workflow:** 7 tipos de aditivo (prazo, valor, prazo_e_valor, supressao, reequilibrio, alteracao_clausula, misto), limites legais configuráveis (ConfiguracaoLimiteAditivo), reequilíbrio econômico-financeiro, workflow de aprovação 5 etapas (WorkflowAprovacao)
- **Fase 4 — Alertas (Motor de Monitoramento):** Command agendado (cron diário) + Queue (Redis) + Notifications (mail + database) + Dashboard de alertas + Configuração de prazos + Log de notificação + Bloqueio preventivo + Resolução automática
- **Fase 5 — Dashboard Executivo + Painel de Risco:** Painel Executivo com 5 blocos estratégicos (financeiro, risco, vencimentos, secretarias, essenciais), score de gestão 0-100, tendências mensais, ranking de fornecedores, visão do controlador, agregação noturna, cache Redis + Painel de Risco Administrativo dedicado (score expandido com 5 categorias, ranking de risco, mapa por secretaria, relatório TCE de risco, alertas preventivos inteligentes)
- **Fase 6 — Refinamento:** Testes end-to-end, ajustes de UX, performance, segurança expandida (MFA), relatórios gerenciais e exportação

---

## Registro de Implementações

| ID | Data | Descrição | Arquivos Afetados | Status |
|---|---|---|---|---|
| IMP-001 | 2026-02-18 | Preenchimento das bases de conhecimento do projeto | CLAUDE.md, memory/*.md | Concluído |
| IMP-002 | 2026-02-18 | Detalhamento do Módulo 1 — Cadastro Inteligente de Contratos | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-003 | 2026-02-18 | Detalhamento do Módulo 2 — Alertas Automáticos de Vencimento | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-004 | 2026-02-18 | Detalhamento do Módulo 3 — Painel Executivo (Dashboard) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-005 | 2026-02-18 | Detalhamento do Módulo 4 — Gestão de Aditivos (expansão completa: 7 tipos, limites legais, reequilíbrio, score de risco, timeline, dashboard) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-006 | 2026-02-18 | Detalhamento do Módulo 5 — Central de Documentos (pasta digital por contrato, 12 tipos de documento, versionamento não-destrutivo, log de acesso, completude documental, validações automáticas, busca inteligente, dashboard de indicadores, relatório TCE, OCR como Fase 2) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-007 | 2026-02-18 | Detalhamento do Módulo 6 — Painel de Risco Administrativo (grande diferencial estratégico: score expandido com 5 categorias de risco, dashboard dedicado com ranking e semáforo, mapa de risco por secretaria, relatório automatizado para TCE, alertas preventivos inteligentes, WhatsApp como Fase 2) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-008 | 2026-02-18 | Detalhamento dos Requisitos Técnicos Estratégicos — SaaS multi-tenant com banco isolado por prefeitura, segurança expandida (Argon2id, MFA, lockout, logs de login), LGPD (base legal, retenção, anonimização), auditoria (hash SHA-256, logs imutáveis, relatórios exportáveis), performance (capacidade por tenant, paginação, disponibilidade 24/7), armazenamento S3-compatible, requisitos não-funcionais de UI | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-009 | 2026-02-18 | Detalhamento do Módulo 7 — Perfis de Usuário (RBAC): 8 perfis dinâmicos (tabela roles), permissões granulares por recurso.ação, escopo por secretaria, permissões temporárias com expires_at, workflow de aprovação 5 etapas para aditivos, logs de auditoria expandidos com perfil do usuário | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md | Concluído |
| IMP-010 | 2026-02-18 | Expansão do Módulo 7 — Perfis de Usuário: objetivos estratégicos do módulo (segregação, rastreabilidade, antifraude, controle formal), ocupantes típicos por perfil, matriz de permissões granulares completa (12 recursos × 8 perfis com indicação de escopo por secretaria), exemplo concreto de log de auditoria, regras de segurança de autenticação/sessão (MFA, JWT/Sanctum, lockout, TLS) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md | Concluído |
| IMP-011 | 2026-02-19 | Remediação de segurança pré-implementação — auditoria completa identificou 20 lacunas de segurança nas bases de conhecimento. Correções: (1) resolução de tenant via subdomínio DNS (ADR-056), (2) estratégia de anonimização LGPD de dois planos (ADR-057), (3) política de senhas, (4) campo role_nome em HistoricoAlteracao, (5) campo tenant_id em LoginLog, (6) matriz de criptografia LGPD, (7) validação MIME real, (8) hasPermission() com verificação em tempo real de expires_at, (9) MFA obrigatório para admin/controladoria (ADR-055), (10) configuração CORS, (11) triggers MySQL de imutabilidade, (12) isolamento S3 V1/V2 (ADR-058), (13) fluxo de reset de senha, (14) Sanctum token abilities, (15) invalidação de sessão, (16) checklist de hardening, (17) rate limiting API, (18) limites do admin em tabelas imutáveis, (19) verificação automática de hash, (20) credenciais MinIO dev | memory/conhecimento/entidades.md, memory/regras/seguranca.md, memory/regras/multi-tenant.md, memory/regras/rbac.md, memory/regras/auditoria-performance.md, memory/regras/ambiente-git-testes.md, memory/conhecimento/rbac.md, memory/conhecimento/transversal.md, memory/memoria/adrs.md | Concluído |
| IMP-012 | 2026-02-19 | Fase 1a completa — Scaffold Laravel 12 via Sail (PHP 8.5, MySQL 8.4, Redis, MinIO), configuração Argon2id (ADR-044), guard admin, connection tenant dinâmica, migrations master (tenants, admin_users, admin_login_logs), migrations tenant (users placeholder), Models (Tenant, AdminUser, AdminLoginLog append-only), Middleware SetTenantConnection (ADR-056) + EnsureAdminSaaS, commands tenant:create + tenant:migrate, TenantService, Admin SaaS (AuthController, TenantController, views Bootstrap, rotas /admin-saas/*), AdminUserSeeder, script MySQL grant-create-db | compose.yaml, .env.example, config/hashing.php, config/auth.php, config/database.php, config/app.php, bootstrap/app.php, app/Models/*.php, app/Http/Middleware/*.php, app/Console/Commands/*.php, app/Services/TenantService.php, app/Http/Controllers/AdminSaaS/*.php, routes/admin-saas.php, resources/views/admin-saas/**/*.blade.php, database/migrations/*.php, database/seeders/*.php | Concluído |
| IMP-013 | 2026-02-19 | Fase 1b completa — Integração WowDash (assets copiados, 6+2 Blade components, 3 layouts), autenticação tenant (login/logout/forgot-password com guard web + connection tenant), LoginLog append-only (ADR-048), lockout 5 tentativas/15min via RateLimiter (ADR-046), sessão configurável SESSION_LIFETIME (ADR-049), migração admin-saas para WowDash (layout+sidebar+views), redirect guest diferenciado admin vs tenant | public/assets/**, resources/views/components/*.blade.php, resources/views/layout/*.blade.php, resources/views/auth/*.blade.php, resources/views/tenant/dashboard.blade.php, resources/views/admin-saas/**/*.blade.php, app/Models/User.php, app/Models/LoginLog.php, app/Http/Requests/Auth/LoginRequest.php, app/Http/Controllers/Auth/*.php, app/Http/Controllers/Tenant/DashboardController.php, database/migrations/tenant/2026_02_19_000002_create_login_logs_table.php, routes/web.php, bootstrap/app.php | Concluído |
| IMP-014 | 2026-02-19 | Fase 1c completa — Migrations base: roles (8 perfis padrao RN-304), secretarias, fornecedores (com SoftDeletes), alter login_logs (add tenant_id ADR-048), alter users (FK role_id com nullOnDelete). Models Role/Secretaria/Fornecedor (connection tenant). User.belongsTo(Role). FornecedorService (validacao CNPJ RN-038 + formatacao). CnpjValido Rule. Form Requests tenant (Store/Update Secretaria e Fornecedor). SecretariasController + FornecedoresController (CRUD completo). 6 views Blade WowDash (index/create/edit). Resource routes em web.php. Sidebar ativada (Fornecedores/Secretarias com active-page). RoleSeeder integrado em TenantService e TenantCreateCommand. Correcao Tenant.php (casts() method, remocao tenantUsers). LoginLog.fillable + LoginRequest com tenant_id | database/migrations/tenant/000003-000007, app/Models/Role.php, app/Models/Secretaria.php, app/Models/Fornecedor.php, app/Models/User.php, app/Models/LoginLog.php, app/Models/Tenant.php, app/Services/FornecedorService.php, app/Rules/CnpjValido.php, app/Http/Requests/Tenant/*.php, app/Http/Controllers/Tenant/SecretariasController.php, app/Http/Controllers/Tenant/FornecedoresController.php, resources/views/tenant/secretarias/*.blade.php, resources/views/tenant/fornecedores/*.blade.php, resources/views/components/sidebar.blade.php, routes/web.php, database/seeders/RoleSeeder.php, app/Services/TenantService.php, app/Console/Commands/TenantCreateCommand.php, app/Http/Requests/Auth/LoginRequest.php | Concluído |
| IMP-016 | 2026-02-20 | Fase 3a completa — Modulo Contratos: 8 Enums (StatusContrato, TipoContrato, ModalidadeContratacao, TipoPagamento, CategoriaContrato, CategoriaServico, NivelRisco, TipoDocumentoContratual). 5 Migrations tenant (contratos 30+ campos com indices, fiscais com historico, execucoes_financeiras, historico_alteracoes polomorfica imutavel, documentos basico). 5 Models (Contrato com SoftDeletes/casts/relacionamentos/accessors, Fiscal, ExecucaoFinanceira, HistoricoAlteracao append-only, Documento polomorfico). 5 Services (ContratoService com geracao numero NNN/AAAA + prazo_meses + orchestracao, RiscoService com 7 criterios + 3 niveis, AuditoriaService com snapshot role_nome RN-341, FiscalService com designar/trocar, ExecucaoFinanceiraService com recalculo percentual). 5 Form Requests (StoreContrato com validacoes condicionais RN-025/026/028, UpdateContrato com bloqueio vencido RN-006, StoreFiscal, UpdateFiscal, StoreExecucaoFinanceira). 3 Controllers (ContratosController CRUD+show+filtros, FiscaisController aninhado, ExecucoesFinanceirasController aninhado). 4 Views (index com filtros+badges, create wizard 6 etapas com JS, edit formulario unico, show com 6 abas). ContratoSeeder com 5 contratos exemplo. Sidebar ativada com rotas reais. Rotas resource + aninhadas com middleware permission | app/Enums/*.php, database/migrations/tenant/000012-000016, app/Models/Contrato.php, app/Models/Fiscal.php, app/Models/ExecucaoFinanceira.php, app/Models/HistoricoAlteracao.php, app/Models/Documento.php, app/Models/Fornecedor.php, app/Models/Secretaria.php, app/Services/ContratoService.php, app/Services/RiscoService.php, app/Services/AuditoriaService.php, app/Services/FiscalService.php, app/Services/ExecucaoFinanceiraService.php, app/Http/Requests/Tenant/Store*Contrato*.php, app/Http/Requests/Tenant/Store*Fiscal*.php, app/Http/Requests/Tenant/StoreExecucaoFinanceiraRequest.php, app/Http/Controllers/Tenant/ContratosController.php, app/Http/Controllers/Tenant/FiscaisController.php, app/Http/Controllers/Tenant/ExecucoesFinanceirasController.php, resources/views/tenant/contratos/*.blade.php, resources/views/components/sidebar.blade.php, routes/web.php, database/seeders/ContratoSeeder.php, app/Services/TenantService.php | Concluído |
| IMP-015 | 2026-02-20 | Fase 2 completa — RBAC Base: migrations (permissions, role_permissions, user_permissions, user_secretarias). Model Permission (ADR-051). Role.belongsToMany(Permission). User atualizado: belongsToMany(Secretaria) (ADR-054), permissions() com pivot expires_at/concedido_por (ADR-053), hasPermission() com verificacao real-time expires_at (RN-303/RN-330), hasRole(), isPerfilEstrategico() (RN-327). Middleware EnsureUserHasPermission (route parameter). PermissaoService (verificar, atribuir, revogar, sincronizar). VerificarPermissoesExpiradasCommand (RN-333). PermissionSeeder (36 permissoes em 13 grupos). RolePermissionSeeder (matriz 8 perfis conforme RN-305 a RN-320). CRUD Users (controller, form requests com authorize via hasPermission, views com role+secretarias). CRUD Roles (controller, form requests, views com protecao is_padrao). PermissoesController (matriz checkboxes agrupada por grupo). Sidebar dinamico condicional por permissao. Rotas protegidas por middleware permission. TenantService integrado com novos seeders | database/migrations/tenant/000008-000011, app/Models/Permission.php, app/Models/Role.php, app/Models/User.php, app/Http/Middleware/EnsureUserHasPermission.php, app/Services/PermissaoService.php, app/Console/Commands/VerificarPermissoesExpiradasCommand.php, database/seeders/PermissionSeeder.php, database/seeders/RolePermissionSeeder.php, app/Http/Controllers/Tenant/UsersController.php, app/Http/Controllers/Tenant/RolesController.php, app/Http/Controllers/Tenant/PermissoesController.php, app/Http/Requests/Tenant/Store*UserRequest.php, app/Http/Requests/Tenant/Store*RoleRequest.php, resources/views/tenant/users/*.blade.php, resources/views/tenant/roles/*.blade.php, resources/views/tenant/permissoes/index.blade.php, resources/views/components/sidebar.blade.php, routes/web.php, bootstrap/app.php, app/Services/TenantService.php | Concluído |

### Como registrar:
1. Use ID sequencial (IMP-XXX)
2. Descreva o que foi feito (não como)
3. Liste os arquivos principais afetados
4. Status: `Concluído` | `Parcial` | `Revertido`

---

## Problemas Conhecidos

| ID | Descrição | Severidade | Módulo | Status |
|---|---|---|---|---|
| — | Nenhum problema registrado | — | — | — |

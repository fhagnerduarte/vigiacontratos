# Memória Core — Estado Atual e Implementações

> Extraído de `banco-de-memoria.md`. Carregado em **TODAS** as tarefas.
> Consultado pelo **Gestor de Memória** (Agente 02) antes de cada ação.
> Atualizado ao final de cada implementação significativa (Etapa 7 do pipeline).

---

## Estado Atual

| Campo | Valor |
|---|---|
| Projeto | vigiacontratos |
| Tipo | Sistema de gestão contratual municipal |
| Fase Atual | Fase 6 — Refinamento (em andamento) |
| Última Atualização | 2026-02-23 |
| Próximo Passo | Continuar Fase 6 — Testes integração avançados, UX/Performance, pendências restantes |
| Branch Ativa | `homolog` criada em 2026-02-20 — fluxo de branching ativo |
| Fluxo Git | `feature/*` → PR → `homolog` → (validação) → `main` |

### Cadeia de Fases

```
[Fase 0: Setup] → [Fase 1a: Ambiente+MultiTenant] → [Fase 1b: Template+Auth] → [Fase 1c: Migrations Base] → [Fase 2: RBAC Base] → [Fase 3a: Contratos] → [Fase 3b: Documentos] → [Fase 3c: Aditivos+Workflow] → [Fase 4: Alertas] → [Fase 5: Dashboard+Risco] → [Fase 6: Refinamento]
  ✅              ✅                    ✅                ✅                  ✅             ✅              ✅               ✅                     ✅             ✅                   ▲ em andamento
```

**Detalhamento das Fases:**
- **Fase 0 — Setup Inicial:** Preencher bases de conhecimento, definir stack e convenções
- **Fase 1a — Ambiente + Multi-Tenant:** Laravel 12 via Sail, Docker (MySQL 8 + Redis), banco master (tenants, tenant_users), middleware SetTenantConnection, commands tenant:create e tenant:migrate, configuração S3-compatible
- **Fase 1b — Template + Autenticação:** Integrar WowDash (assets, layout Blade, sidebar, navbar), autenticação (login, logout, forgot password), Argon2id, login logs (LoginLog), lockout após 5 tentativas
- **Fase 1c — Migrations Base:** Tabela users (com role_id FK), secretarias, fornecedores, CRUD base de Secretarias e Fornecedores
- **Fase 2 — RBAC Base:** roles, permissions, role_permissions, user_permissions, user_secretarias, middleware EnsureUserHasPermission, policies, seeder dos 8 perfis, UI de gestão de roles/permissões *(sem workflow de aprovação — movido para Fase 3c)*
- **Fase 3a — Contratos:** Wizard multi-etapa, CRUD completo de Contratos + Fiscais (com histórico de trocas) + Execução Financeira + Score de Risco + Audit Trail (historico_alteracoes)
- **Fase 3b — Documentos (Central de Documentos):** Pasta digital por contrato, 12 tipos de documento, versionamento automático não-destrutivo, completude documental, log de acesso, hash SHA-256, busca inteligente, dashboard de indicadores, relatório TCE
- **Fase 3c — Aditivos + Workflow:** 7 tipos de aditivo (prazo, valor, prazo_e_valor, supressao, reequilibrio, alteracao_clausula, misto), limites legais configuráveis (ConfiguracaoLimiteAditivo), reequilíbrio econômico-financeiro, workflow de aprovação 5 etapas (WorkflowAprovacao)
- **Fase 4 — Alertas (Motor de Monitoramento):** Command agendado (cron diário) + Queue (Redis) + Notifications (mail + database) + Dashboard de alertas + Configuração de prazos + Log de notificação + Bloqueio preventivo + Resolução automática
- **Fase 5 — Dashboard Executivo + Painel de Risco:** Painel Executivo com 5 blocos estratégicos (financeiro, risco, vencimentos, secretarias, essenciais), score de gestão 0-100, tendências mensais, ranking de fornecedores, visão do controlador, agregação noturna, cache Redis + Painel de Risco Administrativo dedicado (score expandido com 5 categorias, ranking de risco, mapa por secretaria, relatório TCE de risco, alertas preventivos inteligentes)
- **Fase 6 — Refinamento:** Testes end-to-end, ajustes de UX, performance, segurança expandida (MFA), relatórios gerenciais e exportação

---

## Registro de Implementações

| ID | Data | Descrição | Arquivos Afetados | Status |
|---|---|---|---|---|
| IMP-001 | 2026-02-18 | Preenchimento das bases de conhecimento do projeto | CLAUDE.md, memory/*.md | Concluído |
| IMP-002 | 2026-02-18 | Detalhamento do Módulo 1 — Cadastro Inteligente de Contratos | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-003 | 2026-02-18 | Detalhamento do Módulo 2 — Alertas Automáticos de Vencimento | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-004 | 2026-02-18 | Detalhamento do Módulo 3 — Painel Executivo (Dashboard) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-005 | 2026-02-18 | Detalhamento do Módulo 4 — Gestão de Aditivos (expansão completa: 7 tipos, limites legais, reequilíbrio, score de risco, timeline, dashboard) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-006 | 2026-02-18 | Detalhamento do Módulo 5 — Central de Documentos (pasta digital por contrato, 12 tipos de documento, versionamento não-destrutivo, log de acesso, completude documental, validações automáticas, busca inteligente, dashboard de indicadores, relatório TCE, OCR como Fase 2) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-007 | 2026-02-18 | Detalhamento do Módulo 6 — Painel de Risco Administrativo (grande diferencial estratégico: score expandido com 5 categorias de risco, dashboard dedicado com ranking e semáforo, mapa de risco por secretaria, relatório automatizado para TCE, alertas preventivos inteligentes, WhatsApp como Fase 2) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-008 | 2026-02-18 | Detalhamento dos Requisitos Técnicos Estratégicos — SaaS multi-tenant com banco isolado por prefeitura, segurança expandida (Argon2id, MFA, lockout, logs de login), LGPD (base legal, retenção, anonimização), auditoria (hash SHA-256, logs imutáveis, relatórios exportáveis), performance (capacidade por tenant, paginação, disponibilidade 24/7), armazenamento S3-compatible, requisitos não-funcionais de UI | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md, memory/banco-de-tema.md | Concluído |
| IMP-009 | 2026-02-18 | Detalhamento do Módulo 7 — Perfis de Usuário (RBAC): 8 perfis dinâmicos (tabela roles), permissões granulares por recurso.ação, escopo por secretaria, permissões temporárias com expires_at, workflow de aprovação 5 etapas para aditivos, logs de auditoria expandidos com perfil do usuário | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md | Concluído |
| IMP-010 | 2026-02-18 | Expansão do Módulo 7 — Perfis de Usuário: objetivos estratégicos do módulo (segregação, rastreabilidade, antifraude, controle formal), ocupantes típicos por perfil, matriz de permissões granulares completa (12 recursos × 8 perfis com indicação de escopo por secretaria), exemplo concreto de log de auditoria, regras de segurança de autenticação/sessão (MFA, JWT/Sanctum, lockout, TLS) | memory/banco-de-conhecimento.md, memory/banco-de-regras.md, memory/banco-de-memoria.md, memory/MEMORY.md | Concluído |
| IMP-011 | 2026-02-19 | Remediação de segurança pré-implementação — auditoria completa identificou 20 lacunas de segurança nas bases de conhecimento. Correções: (1) resolução de tenant via subdomínio DNS (ADR-056), (2) estratégia de anonimização LGPD de dois planos (ADR-057), (3) política de senhas, (4) campo role_nome em HistoricoAlteracao, (5) campo tenant_id em LoginLog, (6) matriz de criptografia LGPD, (7) validação MIME real, (8) hasPermission() com verificação em tempo real de expires_at, (9) MFA obrigatório para admin/controladoria (ADR-055), (10) configuração CORS, (11) triggers MySQL de imutabilidade, (12) isolamento S3 V1/V2 (ADR-058), (13) fluxo de reset de senha, (14) Sanctum token abilities, (15) invalidação de sessão, (16) checklist de hardening, (17) rate limiting API, (18) limites do admin em tabelas imutáveis, (19) verificação automática de hash, (20) credenciais MinIO dev | memory/conhecimento/entidades.md, memory/regras/seguranca.md, memory/regras/multi-tenant.md, memory/regras/rbac.md, memory/regras/auditoria-performance.md, memory/regras/ambiente-git-testes.md, memory/conhecimento/rbac.md, memory/conhecimento/transversal.md, memory/memoria/adrs.md | Concluído |
| IMP-012 | 2026-02-19 | Fase 1a completa — Scaffold Laravel 12 via Sail (PHP 8.5, MySQL 8.4, Redis, MinIO), configuração Argon2id (ADR-044), guard admin, connection tenant dinâmica, migrations master (tenants, admin_users, admin_login_logs), migrations tenant (users placeholder), Models (Tenant, AdminUser, AdminLoginLog append-only), Middleware SetTenantConnection (ADR-056) + EnsureAdminSaaS, commands tenant:create + tenant:migrate, TenantService, Admin SaaS (AuthController, TenantController, views Bootstrap, rotas /admin-saas/*), AdminUserSeeder, script MySQL grant-create-db | compose.yaml, .env.example, config/hashing.php, config/auth.php, config/database.php, config/app.php, bootstrap/app.php, app/Models/*.php, app/Http/Middleware/*.php, app/Console/Commands/*.php, app/Services/TenantService.php, app/Http/Controllers/AdminSaaS/*.php, routes/admin-saas.php, resources/views/admin-saas/**/*.blade.php, database/migrations/*.php, database/seeders/*.php | Concluído |
| IMP-013 | 2026-02-19 | Fase 1b completa — Integração WowDash (assets copiados, 6+2 Blade components, 3 layouts), autenticação tenant (login/logout/forgot-password com guard web + connection tenant), LoginLog append-only (ADR-048), lockout 5 tentativas/15min via RateLimiter (ADR-046), sessão configurável SESSION_LIFETIME (ADR-049), migração admin-saas para WowDash (layout+sidebar+views), redirect guest diferenciado admin vs tenant | public/assets/**, resources/views/components/*.blade.php, resources/views/layout/*.blade.php, resources/views/auth/*.blade.php, resources/views/tenant/dashboard.blade.php, resources/views/admin-saas/**/*.blade.php, app/Models/User.php, app/Models/LoginLog.php, app/Http/Requests/Auth/LoginRequest.php, app/Http/Controllers/Auth/*.php, app/Http/Controllers/Tenant/DashboardController.php, database/migrations/tenant/2026_02_19_000002_create_login_logs_table.php, routes/web.php, bootstrap/app.php | Concluído |
| IMP-014 | 2026-02-19 | Fase 1c completa — Migrations base: roles (8 perfis padrao RN-304), secretarias, fornecedores (com SoftDeletes), alter login_logs (add tenant_id ADR-048), alter users (FK role_id com nullOnDelete). Models Role/Secretaria/Fornecedor (connection tenant). User.belongsTo(Role). FornecedorService (validacao CNPJ RN-038 + formatacao). CnpjValido Rule. Form Requests tenant (Store/Update Secretaria e Fornecedor). SecretariasController + FornecedoresController (CRUD completo). 6 views Blade WowDash (index/create/edit). Resource routes em web.php. Sidebar ativada (Fornecedores/Secretarias com active-page). RoleSeeder integrado em TenantService e TenantCreateCommand. Correcao Tenant.php (casts() method, remocao tenantUsers). LoginLog.fillable + LoginRequest com tenant_id | database/migrations/tenant/000003-000007, app/Models/Role.php, app/Models/Secretaria.php, app/Models/Fornecedor.php, app/Models/User.php, app/Models/LoginLog.php, app/Models/Tenant.php, app/Services/FornecedorService.php, app/Rules/CnpjValido.php, app/Http/Requests/Tenant/*.php, app/Http/Controllers/Tenant/SecretariasController.php, app/Http/Controllers/Tenant/FornecedoresController.php, resources/views/tenant/secretarias/*.blade.php, resources/views/tenant/fornecedores/*.blade.php, resources/views/components/sidebar.blade.php, routes/web.php, database/seeders/RoleSeeder.php, app/Services/TenantService.php, app/Console/Commands/TenantCreateCommand.php, app/Http/Requests/Auth/LoginRequest.php | Concluído |
| IMP-016 | 2026-02-20 | Fase 3a completa — Modulo Contratos: 8 Enums (StatusContrato, TipoContrato, ModalidadeContratacao, TipoPagamento, CategoriaContrato, CategoriaServico, NivelRisco, TipoDocumentoContratual). 5 Migrations tenant (contratos 30+ campos com indices, fiscais com historico, execucoes_financeiras, historico_alteracoes polomorfica imutavel, documentos basico). 5 Models (Contrato com SoftDeletes/casts/relacionamentos/accessors, Fiscal, ExecucaoFinanceira, HistoricoAlteracao append-only, Documento polomorfico). 5 Services (ContratoService com geracao numero NNN/AAAA + prazo_meses + orchestracao, RiscoService com 7 criterios + 3 niveis, AuditoriaService com snapshot role_nome RN-341, FiscalService com designar/trocar, ExecucaoFinanceiraService com recalculo percentual). 5 Form Requests (StoreContrato com validacoes condicionais RN-025/026/028, UpdateContrato com bloqueio vencido RN-006, StoreFiscal, UpdateFiscal, StoreExecucaoFinanceira). 3 Controllers (ContratosController CRUD+show+filtros, FiscaisController aninhado, ExecucoesFinanceirasController aninhado). 4 Views (index com filtros+badges, create wizard 6 etapas com JS, edit formulario unico, show com 6 abas). ContratoSeeder com 5 contratos exemplo. Sidebar ativada com rotas reais. Rotas resource + aninhadas com middleware permission | app/Enums/*.php, database/migrations/tenant/000012-000016, app/Models/Contrato.php, app/Models/Fiscal.php, app/Models/ExecucaoFinanceira.php, app/Models/HistoricoAlteracao.php, app/Models/Documento.php, app/Models/Fornecedor.php, app/Models/Secretaria.php, app/Services/ContratoService.php, app/Services/RiscoService.php, app/Services/AuditoriaService.php, app/Services/FiscalService.php, app/Services/ExecucaoFinanceiraService.php, app/Http/Requests/Tenant/Store*Contrato*.php, app/Http/Requests/Tenant/Store*Fiscal*.php, app/Http/Requests/Tenant/StoreExecucaoFinanceiraRequest.php, app/Http/Controllers/Tenant/ContratosController.php, app/Http/Controllers/Tenant/FiscaisController.php, app/Http/Controllers/Tenant/ExecucoesFinanceirasController.php, resources/views/tenant/contratos/*.blade.php, resources/views/components/sidebar.blade.php, routes/web.php, database/seeders/ContratoSeeder.php, app/Services/TenantService.php | Concluído |
| IMP-017 | 2026-02-20 | Fase 3b completa — Modulo Documentos (Central de Documentos): 2 Enums novos (StatusCompletudeDocumental com label/cor/icone, AcaoLogDocumento com 5 acoes). 2 Migrations tenant (alter documentos: add nome_arquivo/descricao/versao/is_versao_atual, rename path→caminho/tamanho_bytes→tamanho, hash_integridade nullable, indices tipo_documento+is_versao_atual; create log_acesso_documentos append-only com FK documento+user). Model LogAcessoDocumento (append-only booted, sem updated_at). Model Documento expandido ($fillable alinhado, casts boolean/integer, scopeVersaoAtual, hasMany logsAcesso). Model Contrato expandido (accessor getStatusCompletudeAttribute RN-128 com checklist 4 tipos obrigatorios, documentosVersaoAtual). DocumentoService (upload com versionamento automatico RN-120 + nome padronizado RN-121 + storage isolado ADR-033 + hash SHA-256 ADR-047 + magic bytes PDF + log acesso RN-122; download autenticado; excluir soft delete RN-134; verificarChecklist RN-129; gerarIndicadoresDashboard RN-132). StoreDocumentoRequest (mimes:pdf max:20480 tipo_documento Enum). DocumentosController (index Central com indicadores+filtros+completude, store upload aninhado contrato, download, destroy). 4 rotas (GET documentos, POST contratos/{contrato}/documentos, GET documentos/{documento}/download, DELETE documentos/{documento}) com middleware permission. View documentos/index.blade.php (4 cards indicadores, filtros combinados RN-131, tabela contratos com badge completude). View contratos/show.blade.php aba Documentos expandida (barra completude, checklist obrigatorio, documentos agrupados por tipo com versoes, modal upload). Sidebar ativada com rota real. PermissionSeeder: +documento.download (37 permissoes total). RolePermissionSeeder: documento.download em todos os 8 perfis. DocumentoSeeder com documentos exemplo. TenantService integrado | app/Enums/StatusCompletudeDocumental.php, app/Enums/AcaoLogDocumento.php, database/migrations/tenant/000017-000018, app/Models/LogAcessoDocumento.php, app/Models/Documento.php, app/Models/Contrato.php, app/Services/DocumentoService.php, app/Http/Requests/Tenant/StoreDocumentoRequest.php, app/Http/Controllers/Tenant/DocumentosController.php, app/Http/Controllers/Tenant/ContratosController.php, resources/views/tenant/documentos/index.blade.php, resources/views/tenant/contratos/show.blade.php, resources/views/components/sidebar.blade.php, routes/web.php, database/seeders/PermissionSeeder.php, database/seeders/RolePermissionSeeder.php, database/seeders/DocumentoSeeder.php, app/Services/TenantService.php | Concluído |
| IMP-018 | 2026-02-21 | Servidores (extra) — CRUD Servidores: migration create_servidores (nome, cpf unique, matricula unique, cargo, secretaria_id FK, email, telefone, is_ativo), migration alter_contratos_add_servidor_id (FK nullable). Model Servidor (connection tenant, belongsTo Secretaria, hasMany Contrato). CpfValido Rule. Store/Update ServidorRequest. ServidoresController CRUD completo. Views servidores (index/create/edit com badge status, mascara CPF/telefone). ServidorSeeder. PermissionSeeder +servidor.* (41 total). RolePermissionSeeder distribuido nos 8 perfis. Gestor contrato refatorado: gestor_nome substituido por servidor_id (select Server Select2). Show contrato exibe servidor gestor com fallback | database/migrations/tenant/000019-000020, app/Models/Servidor.php, app/Models/Contrato.php, app/Models/Secretaria.php, app/Rules/CpfValido.php, app/Http/Requests/Tenant/Store*ServidorRequest.php, app/Http/Controllers/Tenant/ServidoresController.php, resources/views/tenant/servidores/*.blade.php, database/seeders/ServidorSeeder.php, database/seeders/PermissionSeeder.php, database/seeders/RolePermissionSeeder.php, app/Services/TenantService.php, routes/web.php, resources/views/components/sidebar.blade.php, resources/views/tenant/contratos/create.blade.php, resources/views/tenant/contratos/edit.blade.php, resources/views/tenant/contratos/show.blade.php, app/Http/Requests/Tenant/StoreContratoRequest.php, app/Http/Requests/Tenant/UpdateContratoRequest.php | Concluído |
| IMP-019 | 2026-02-21 | Fiscal→Servidor — migration alter_fiscais_add_servidor_id (FK nullable → servidores, nullOnDelete). Model Fiscal + Servidor atualizados (servidor_id, belongsTo/hasMany). FiscalService designar/trocar recebem servidor_id com snapshot. StoreFiscalRequest + StoreContratoRequest refatorados (fiscal_servidor_id). Views contrato create/show refatoradas (select servidor Select2 para designar fiscal) | database/migrations/tenant/000021, app/Models/Fiscal.php, app/Models/Servidor.php, app/Services/FiscalService.php, app/Http/Requests/Tenant/StoreFiscalRequest.php, app/Http/Requests/Tenant/StoreContratoRequest.php, app/Http/Controllers/Tenant/FiscaisController.php, app/Http/Controllers/Tenant/ContratosController.php, app/Services/ContratoService.php, resources/views/tenant/contratos/create.blade.php, resources/views/tenant/contratos/show.blade.php | Concluído |
| IMP-020 | 2026-02-22 | Fase 3c completa — Modulo Aditivos + Workflow: 4 Enums novos (TipoAditivo 7 valores, StatusAditivo 3 valores, StatusAprovacao 3 valores, EtapaWorkflow 5 etapas). 3 Migrations tenant (create_aditivos 20+ campos com SoftDeletes/indices, create_configuracoes_limite_aditivo, create_workflow_aprovacoes polomorfico + decided_at). 3 Models novos (Aditivo com SoftDeletes/casts/relationships/accessors workflow, ConfiguracaoLimiteAditivo, WorkflowAprovacao append-only com booted imutabilidade). 2 Services novos (AditivoService: gerarNumeroSequencial RN-091 + calcularPercentualAcumulado RN-097 + verificarLimiteLegal RN-098/099 + criar transacional RN-103 + atualizarContratoPai + cancelar RN-116 + processarReequilibrio RN-095; WorkflowService: criarFluxo 5 etapas RN-335 + aprovar RN-337 + reprovar RN-338 + decided_at timestamp). AditivosController (index dashboard RN-109/114, create, store com verificacao limites, show com workflow, aprovar, reprovar, cancelar). StoreAditivoRequest (validacoes condicionais por tipo RN-088/096 + nova_data_fim after data_fim atual RN-010 + data_inicio_vigencia required RN-092). 3 Views (index dashboard indicadores+rankings, create wizard condicional+Select2+mascaras, show timeline+detalhes+workflow stepper+aprovar/reprovar/cancelar). RiscoService expandido +3 criterios aditivos RN-106/107/108. Contrato model +aditivos()/aditivosVigentes(). ContratosController show +aba aditivos. Sidebar +link Aditivos. 7 rotas (index, create, store, show, aprovar, reprovar, cancelar). ConfiguracaoLimiteAditivoSeeder (4 tipos: servico 25%, obra 50%, compra 25%, locacao 25%). AditivoSeeder (4 aditivos exemplo com workflows variados). TenantService integrado (+ConfiguracaoLimiteAditivoSeeder +AditivoSeeder) | app/Enums/TipoAditivo.php, app/Enums/StatusAditivo.php, app/Enums/StatusAprovacao.php, app/Enums/EtapaWorkflow.php, database/migrations/tenant/000022-000025, app/Models/Aditivo.php, app/Models/ConfiguracaoLimiteAditivo.php, app/Models/WorkflowAprovacao.php, app/Models/Contrato.php, app/Services/AditivoService.php, app/Services/WorkflowService.php, app/Services/RiscoService.php, app/Http/Controllers/Tenant/AditivosController.php, app/Http/Controllers/Tenant/ContratosController.php, app/Http/Requests/Tenant/StoreAditivoRequest.php, resources/views/tenant/aditivos/*.blade.php, resources/views/tenant/contratos/show.blade.php, resources/views/components/sidebar.blade.php, routes/web.php, database/seeders/ConfiguracaoLimiteAditivoSeeder.php, database/seeders/AditivoSeeder.php, app/Services/TenantService.php | Concluído |
| IMP-029 | 2026-02-23 | Fase 6 parcial — Modulo Relatorios PDF/Excel: maatwebsite/excel 3.1 instalado. RateLimiter exportacoes (10/min por user). RelatorioService (dadosDocumentosContrato RN-133, dadosAuditoria/CSV RN-222 com 3 fontes unificadas, dadosConformidadeDocumental RN-225 com verificacao integridade SHA-256). GerarRelatorioAuditoriaRequest (validacao filtros). 3 classes Export Maatwebsite (ContratosExport, AlertasExport, FornecedoresExport com FromQuery+WithHeadings+WithMapping+ShouldAutoSize+WithStyles). RelatoriosController (9 metodos: index central, documentosContratoPdf, auditoriaFiltros, auditoriaPdf, auditoriaCsv, conformidadeDocumentalPdf, contratosExcel, alertasExcel, fornecedoresExcel). 5 views novas (index central com 3 secoes de cards por categoria, auditoria-filtros com Select2, 3 templates PDF inline CSS DomPDF: documentos-contrato A4 portrait, auditoria A4 landscape, conformidade-documental A4 landscape). 9 rotas novas (6 relatorios + 3 exportar) com middleware permission + throttle:exportacoes. Sidebar link Relatorios ativado. Botoes "Exportar Excel" adicionados em contratos/alertas/fornecedores index. Botao "Exportar PDF" na aba Documentos do contrato show | app/Services/RelatorioService.php, app/Http/Controllers/Tenant/RelatoriosController.php, app/Http/Requests/Tenant/GerarRelatorioAuditoriaRequest.php, app/Exports/ContratosExport.php, app/Exports/AlertasExport.php, app/Exports/FornecedoresExport.php, resources/views/tenant/relatorios/index.blade.php, resources/views/tenant/relatorios/auditoria-filtros.blade.php, resources/views/tenant/relatorios/pdf/documentos-contrato.blade.php, resources/views/tenant/relatorios/pdf/auditoria.blade.php, resources/views/tenant/relatorios/pdf/conformidade-documental.blade.php, routes/web.php, app/Providers/AppServiceProvider.php, resources/views/components/sidebar.blade.php, resources/views/tenant/contratos/index.blade.php, resources/views/tenant/alertas/index.blade.php, resources/views/tenant/fornecedores/index.blade.php, resources/views/tenant/contratos/show.blade.php | Concluído |
| IMP-030 | 2026-02-23 | Fase 6 — MFA (TOTP) Autenticação Multi-Fator: pragmarx/google2fa-laravel + bacon/bacon-qr-code instalados. 2 migrations (tenant 000031 alter_users_add_mfa_fields: mfa_secret/mfa_enabled_at/mfa_recovery_codes; master 000004 alter_admin_users_add_mfa_fields: mfa_enabled_at/mfa_recovery_codes). Models User + AdminUser atualizados (campos MFA em fillable/hidden/casts, métodos isMfaEnabled/isMfaRequired/isMfaOptional/isMfaSupported). MfaService (generateSecret, generateQrCodeDataUri via BaconQrCode SVG, verifyCode com window ±1, generateRecoveryCodes 8 códigos XXXX-XXXX, useRecoveryCode, enableMfa, disableMfa). Middleware EnsureMfaVerified (redireciona para verify se MFA habilitado sem sessão mfa_verified, redireciona para setup se MFA obrigatório sem configuração). EnsureAdminSaaS expandido com verificação MFA. 2 Controllers MFA (Tenant/MfaController + AdminSaaS/MfaController: setup QR, enable, showVerify, verify, showRecovery, useRecovery, disable). 8 Views MFA WowDash themed (auth/mfa/setup+verify+recovery+recovery-codes, admin-saas/auth/mfa/setup+verify+recovery+recovery-codes). Login flow modificado (AuthenticatedSessionController + AdminAuthController redirecionam para MFA verify/setup após auth). Rotas MFA tenant (7 rotas prefix mfa) + admin-saas (6 rotas prefix admin-saas/mfa). Middleware mfa.verified adicionado ao grupo principal de rotas protegidas tenant. Regras MFA: obrigatório administrador_geral/controladoria/AdminUser, opcional secretario/gestor_contrato/procuradoria/financeiro, sem suporte fiscal_contrato/gabinete. Testes: MfaServiceTest (17 testes), UserMfaTest (15 testes), MfaMiddlewareTest (6 testes) = 38 testes MFA. EnsureUserHasPermissionTest atualizado para sessão mfa_verified. Total suite: 270 testes, 535 assertions | app/Services/MfaService.php, app/Http/Middleware/EnsureMfaVerified.php, app/Http/Middleware/EnsureAdminSaaS.php, app/Http/Controllers/Tenant/MfaController.php, app/Http/Controllers/AdminSaaS/MfaController.php, app/Http/Controllers/Auth/AuthenticatedSessionController.php, app/Http/Controllers/AdminSaaS/AuthController.php, app/Models/User.php, app/Models/AdminUser.php, bootstrap/app.php, routes/web.php, routes/admin-saas.php, database/migrations/tenant/000031, database/migrations/000004, resources/views/auth/mfa/*.blade.php, resources/views/admin-saas/auth/mfa/*.blade.php, tests/Unit/Services/MfaServiceTest.php, tests/Unit/Models/UserMfaTest.php, tests/Feature/Mfa/MfaMiddlewareTest.php | Concluído |
| IMP-031 | 2026-02-23 | Fase 6 — Expansão de Testes Feature Controllers CRUD: 10 arquivos de teste Feature novos (AditivosControllerTest, AlertasControllerTest, ContratosControllerTest, DashboardControllerTest, DocumentosControllerTest, FornecedoresControllerTest, PainelRiscoControllerTest, RolesControllerTest, SecretariasControllerTest, ServidoresControllerTest, UsersControllerTest). Cobertura: index+create+store+edit+update+destroy para todos os CRUDs, validações (required, unique, CNPJ, CPF, date, file upload PDF), filtros (status, secretaria, modalidade, nivel_risco), permissões (403 para roles sem permissão), MFA session handling, soft deletes, workflow aditivos (criar/aprovar/reprovar/cancelar), upload documentos (mime/size/tipo), export PDF TCE, alertas (resolver, configurações). Fix: SecretariaFactory overflow (expandido nomes+numérico), ContratoFactory numero unique (expandido range 1-99999), pendencias.md atualizado (Alertas/Dashboard/PainelRisco marcados como concluídos). Total suite: **398 testes, 809 assertions** (anterior: 270 testes, 535 assertions — +128 testes, +274 assertions) | tests/Feature/Controllers/*.php, database/factories/SecretariaFactory.php, database/factories/ContratoFactory.php, memory/memoria/pendencias.md | Concluído |
| IMP-037 | 2026-02-23 | Fase 6 — Testes Auditoria + ForceHttps + Expansão testes: AuditoriaControllerTest Feature (23 testes: index 3 fontes com filtros tipo_acao/user_id/entidade/periodo/paginacao, show 3 tipos + 404 + permissao, exportar PDF/CSV com validacoes + permissao). LogIntegridadeDocumentoTest Unit (8 testes: criar 3 status, imutabilidade update/delete, relationship documento, casts, created_at). VerificarIntegridadeDocumentosCommandTest Feature (8 testes: sem tenants, com tenant ativo, filtro slug, inexistente, inativos, dispatch queue integridade, mensagem sucesso, propriedades job). Middleware ForceHttps (redirect HTTP→HTTPS 301 em producao, preserva URI, nao redireciona em local/testing). ForceHttpsTest (6 testes). Middleware registrado em bootstrap/app.php alias force.https. Total suite: **443 testes, 911 assertions** (anterior: 398 testes, 809 assertions — +45 testes, +102 assertions) | tests/Feature/Controllers/AuditoriaControllerTest.php, tests/Unit/Models/LogIntegridadeDocumentoTest.php, tests/Feature/Commands/VerificarIntegridadeDocumentosCommandTest.php, app/Http/Middleware/ForceHttps.php, tests/Feature/Middleware/ForceHttpsTest.php, bootstrap/app.php | Concluído |
| IMP-039 | 2026-02-23 | Fase 6 — Bloqueio Preventivo Contratos Vencidos (RN-046/RN-052): Migration add_bloqueio_preventivo_fields (contratos.is_irregular boolean + aditivos.justificativa_retroativa text). Contrato model atualizado (is_irregular fillable/cast/scopeIrregulares). Aditivo model atualizado (justificativa_retroativa fillable). AlertaService.marcarContratosVencidos() seta is_irregular=true junto com status=vencido (RN-046). Novo metodo AlertaService::regularizarContrato() limpa is_irregular. AditivoService::criar() relaxado: aceita contrato vencido com justificativa retroativa obrigatoria (RN-052), aditivo de prazo com data futura regulariza contrato (volta vigente + limpa irregular + resolve alertas). StoreAditivoRequest: regra condicional justificativa_retroativa required se vencido (min 50 chars). AditivosController create/store: aceita Vigente ou Vencido, passa flag exigeJustificativaRetroativa para view. ContratosController.update(): defesa em profundidade para vencido. Views: badge IRREGULAR vermelho na listagem (index) com borda vermelha, banner alerta IRREGULAR na pagina de detalhes (show) com badge no header, botao "Adicionar Aditivo Retroativo" com aviso RN-052, campo justificativa_retroativa no form de aditivos (create). DashboardService.visaoControlador(): contador "Contratos irregulares" na array irregularidades. ContratoFactory: states vencido() e irregular() com is_irregular=true. BloqueioPreventivTest: 18 testes Feature (marcar irregular, nao remarcar, vigente nao afetado, bloqueio edicao, formulario vencido, validacoes justificativa, regularizacao, UI badges, dashboard). AditivoServiceTest: teste existente adaptado para status cancelado (RN-009) + novo teste vencido sem justificativa (RN-052). Total suite: **473 testes, 981 assertions** (anterior: 454 testes, 937 assertions — +19 testes, +44 assertions) | database/migrations/tenant/2026_02_23_000036_add_bloqueio_preventivo_fields.php, app/Models/Contrato.php, app/Models/Aditivo.php, app/Services/AlertaService.php, app/Services/AditivoService.php, app/Services/DashboardService.php, app/Http/Requests/Tenant/StoreAditivoRequest.php, app/Http/Controllers/Tenant/AditivosController.php, app/Http/Controllers/Tenant/ContratosController.php, resources/views/tenant/contratos/index.blade.php, resources/views/tenant/contratos/show.blade.php, resources/views/tenant/aditivos/create.blade.php, database/factories/ContratoFactory.php, tests/Feature/BloqueioPreventivo/BloqueioPreventivTest.php, tests/Unit/Services/AditivoServiceTest.php | Concluído |
| IMP-038 | 2026-02-23 | Fase 6 — Scope Global por Secretaria (RN-326): SecretariaScope Eloquent Global Scope (bypass: sem auth para jobs/CLI, perfis estrategicos admin_geral/controladoria/gabinete RN-327; filtro: whereIn secretaria_id para demais perfis). Registrado em Contrato.booted(). AlertasController.index() filtro whereHas('contrato') para nao-estrategicos (propaga scope via subquery). AditivosController.index() filtro manual na raw query DB (secretariaIds whereIn contratos.secretaria_id). PainelRiscoService.dadosRelatorioTCE() com withoutGlobalScope (relatorio TCE e global). SeedsTenantData helper createUserWithSecretaria(). 11 testes Feature: bypass sem auth + 3 perfis estrategicos + secretario filtra + gestor filtra + multiplas secretarias + sem vinculo = 0 + route model binding 404 + whereHas alerta propaga + withoutGlobalScope desativa. Total suite: **454 testes, 937 assertions** (anterior: 443 testes, 911 assertions — +11 testes, +26 assertions) | app/Models/Scopes/SecretariaScope.php, app/Models/Contrato.php, app/Http/Controllers/Tenant/AlertasController.php, app/Http/Controllers/Tenant/AditivosController.php, app/Services/PainelRiscoService.php, tests/Traits/SeedsTenantData.php, tests/Feature/Scopes/SecretariaScopeTest.php | Concluído |
| IMP-040 | 2026-02-23 | Fase 6 — Relatório de Efetividade Mensal (RN-057): RelatorioService.dadosEfetividadeMensal() calcula contratos regularizados a tempo vs vencidos sem ação vs regularizados retroativamente, taxa de efetividade, tempo médio de antecipação, breakdown por secretaria. Usa withoutGlobalScope(SecretariaScope) para visão global. RelatoriosController: 3 métodos novos (efetividadeMensal tela web, efetividadeMensalPdf DomPDF, efetividadeMensalExcel Maatwebsite). View web WowDash: filtros (mês/ano/secretaria Select2), 6 cards indicadores, gráfico donut ApexCharts, tabela por secretaria, tabela detalhada com badges status. View PDF landscape com resumo executivo, box taxa efetividade, tabelas por secretaria e detalhamento. EfetividadeMensalExport (FromCollection+WithHeadings+ShouldAutoSize+WithStyles). 3 rotas (GET filtros, POST pdf, GET excel) com middleware permission:relatorio.gerar + throttle:exportacoes. Card na Central de Relatórios (seção Auditoria e Conformidade). EfetividadeMensalTest: 17 testes Feature (acesso/permissão, cálculos regularizado/vencido/retroativo, taxas 0%/50%/100%, tempo médio, filtro secretaria, PDF, Excel, mês sem dados, aditivo cancelado, aditivo prazo_e_valor, detalhamento secretaria, tela com indicadores). Total suite: **490 testes, 1027 assertions** (anterior: 473 testes, 981 assertions — +17 testes, +46 assertions) | app/Services/RelatorioService.php, app/Http/Controllers/Tenant/RelatoriosController.php, resources/views/tenant/relatorios/efetividade-mensal.blade.php, resources/views/tenant/relatorios/pdf/efetividade-mensal.blade.php, app/Exports/EfetividadeMensalExport.php, routes/web.php, resources/views/tenant/relatorios/index.blade.php, tests/Feature/Relatorios/EfetividadeMensalTest.php | Concluído |
| IMP-015 | 2026-02-20 | Fase 2 completa — RBAC Base: migrations (permissions, role_permissions, user_permissions, user_secretarias). Model Permission (ADR-051). Role.belongsToMany(Permission). User atualizado: belongsToMany(Secretaria) (ADR-054), permissions() com pivot expires_at/concedido_por (ADR-053), hasPermission() com verificacao real-time expires_at (RN-303/RN-330), hasRole(), isPerfilEstrategico() (RN-327). Middleware EnsureUserHasPermission (route parameter). PermissaoService (verificar, atribuir, revogar, sincronizar). VerificarPermissoesExpiradasCommand (RN-333). PermissionSeeder (36 permissoes em 13 grupos). RolePermissionSeeder (matriz 8 perfis conforme RN-305 a RN-320). CRUD Users (controller, form requests com authorize via hasPermission, views com role+secretarias). CRUD Roles (controller, form requests, views com protecao is_padrao). PermissoesController (matriz checkboxes agrupada por grupo). Sidebar dinamico condicional por permissao. Rotas protegidas por middleware permission. TenantService integrado com novos seeders | database/migrations/tenant/000008-000011, app/Models/Permission.php, app/Models/Role.php, app/Models/User.php, app/Http/Middleware/EnsureUserHasPermission.php, app/Services/PermissaoService.php, app/Console/Commands/VerificarPermissoesExpiradasCommand.php, database/seeders/PermissionSeeder.php, database/seeders/RolePermissionSeeder.php, app/Http/Controllers/Tenant/UsersController.php, app/Http/Controllers/Tenant/RolesController.php, app/Http/Controllers/Tenant/PermissoesController.php, app/Http/Requests/Tenant/Store*UserRequest.php, app/Http/Requests/Tenant/Store*RoleRequest.php, resources/views/tenant/users/*.blade.php, resources/views/tenant/roles/*.blade.php, resources/views/tenant/permissoes/index.blade.php, resources/views/components/sidebar.blade.php, routes/web.php, bootstrap/app.php, app/Services/TenantService.php | Concluído |

| IMP-041 | 2026-02-23 | Fase 6 — Feature Tests Módulos Críticos: Expansão de 4 test files existentes + 1 novo. DashboardControllerTest +8 testes (dados/chaves indicadores, filtros secretaria/modalidade/faixa_valor, view recebe enums, isControlador por perfil, atualizar com mensagem). PainelRiscoControllerTest +7 testes (ranking, mapaSecretarias, indicadores com 6 campos, acesso controladoria/gestor, PDF com nome arquivo). AditivosControllerTest +11 testes (store valor com sucesso, bloqueio limite bloqueante RN-101, nao-bloqueante exige justificativa RN-102, nao-bloqueante com justificativa aceita, aprovar workflow, aprovar sem etapa erro, reprovar com parecer, reprovar sem parecer erro, show dados workflow, index indicadores anuais, create contrato cancelado erro). DocumentosControllerTest +9 testes (upload gera hash, versionamento incrementa versao, download integridade comprometida, download integro stream, verificar-integridade endpoint, verificar-integridade permissao, filtro numero/secretaria, indicadores). ProcessarAlertaJobTest NOVO 8 testes (propriedades tries/backoff/queue, dispatch fila alertas, notificacao usuario, email on-demand, nao envia se resolvido, log sucesso, atualiza status, multiplos destinatarios). ContratoFactory: ampliado range numero 1-999999 para evitar colisao unique. Total suite: **533 testes, 1117 assertions** (anterior: 490 testes, 1027 assertions — +43 testes, +90 assertions) | tests/Feature/Controllers/DashboardControllerTest.php, tests/Feature/Controllers/PainelRiscoControllerTest.php, tests/Feature/Controllers/AditivosControllerTest.php, tests/Feature/Controllers/DocumentosControllerTest.php, tests/Feature/Jobs/ProcessarAlertaJobTest.php, database/factories/ContratoFactory.php | Concluído |

### Como registrar:
1. Use ID sequencial (IMP-XXX)
2. Descreva o que foi feito (não como)
3. Liste os arquivos principais afetados
4. Status: `Concluído` | `Parcial` | `Revertido`

---

## Problemas Conhecidos

| ID | Descrição | Severidade | Módulo | Status |
|---|---|---|---|---|
| — | Nenhum problema registrado | — | — | — |

# Memória — Decisões Arquiteturais (ADRs)

> Extraído de `banco-de-memoria.md`. Carregar ao tomar decisões que possam conflitar com decisões anteriores.
> O Gestor de Memória (Agente 02) **bloqueia** ações que contradigam ADRs registradas.

---

## Decisões Arquiteturais (ADRs)

| ID | Data | Decisão | Contexto | Alternativas Consideradas |
|---|---|---|---|---|
| ADR-001 | 2026-02-18 | Stack: Laravel 12 + PHP 8.2+ + MySQL 8 + Redis | Escolha da stack principal do projeto | Node.js/Express, Python/Django — Laravel escolhido pela produtividade e ecossistema maduro para admin panels |
| ADR-002 | 2026-02-18 | Template UI: WowDash (Bootstrap 5) | Escolha do template admin para o frontend | AdminLTE, Tabler, Tailwind puro — WowDash escolhido pois já disponível e com componentes ricos |
| ADR-003 | 2026-02-18 | Container: Docker / Laravel Sail | Ambiente de desenvolvimento padronizado | PHP local, Herd/Valet — Sail escolhido pela consistência entre ambientes |
| ADR-004 | 2026-02-18 | ~~3 perfis de usuário: Admin, Gestor, Consulta~~ **→ Substituída por ADR-050** | Definição dos níveis de acesso — substituída por RBAC com 8 perfis dinâmicos | ~~2 perfis (admin/operador), RBAC granular~~ — decisão revisada: RBAC completo necessário para segregação institucional |
| ADR-005 | 2026-02-18 | Alertas com prazos configuráveis pelo admin | Como gerenciar antecedência dos alertas de vencimento | Prazos fixos (30/60/90 dias) — configurável dá flexibilidade sem complexidade |
| ADR-006 | 2026-02-18 | Tipos de contrato: Serviços, Obras, Compras, Locação | Tipos iniciais de contrato municipal | Incluir Concessão/Convênio — mantidos os 4 mais comuns, expansível via Enum |
| ADR-007 | 2026-02-18 | Cadastro de contrato via formulário multi-etapa (wizard 6 passos) | UX do cadastro de contratos — garantir qualidade dos dados e reduzir erros | Formulário único longo — wizard escolhido para melhor UX e validação por etapa |
| ADR-008 | 2026-02-18 | Fiscal como entidade separada (tabela `fiscais`) com histórico de trocas | Rastreabilidade de fiscais — auditorias exigem saber quem fiscalizou em cada período | Campo texto simples no contrato — entidade separada permite histórico e validação |
| ADR-009 | 2026-02-18 | Audit trail completo via tabela `historico_alteracoes` (polimórfica, imutável) | Requisito de auditoria e Tribunal de Contas — toda alteração deve ser rastreável | Logs de aplicação, pacote terceiro (Spatie Activity Log) — implementação própria para controle total |
| ADR-010 | 2026-02-18 | Execução financeira como entidade separada (tabela `execucoes_financeiras`) | Acompanhamento do percentual executado e alertas de estouro | Campo percentual manual no contrato — entidade separada permite cálculo automático e histórico |
| ADR-011 | 2026-02-18 | Score de risco automático calculado por critérios objetivos | Diferencial competitivo — classificação de risco encanta controladores internos | Classificação manual — automática é mais consistente e escalável |
| ADR-012 | 2026-02-18 | Modalidade de contratação como Enum (9 valores) | Validações legais dependem da modalidade (dispensa exige fundamento, etc.) | Campo texto livre — Enum garante consistência e permite regras condicionais |
| ADR-013 | 2026-02-18 | Motor de monitoramento via Scheduled Command (cron diário) | Como verificar vencimentos automaticamente — precisa ser confiável, executar diariamente sem intervenção | Evento listener, Webhook externo — Command agendado é nativo do Laravel, confiável e auditável |
| ADR-014 | 2026-02-18 | 6 prazos de alerta configuráveis (120, 90, 60, 30, 15, 7 dias) | Cobertura adequada de prazos para ação preventiva | 3 prazos fixos (30/60/90), prazo único — 6 prazos dão cobertura ampla e são configuráveis pelo admin |
| ADR-015 | 2026-02-18 | Notificações assíncronas via Laravel Queue (Redis) | Envio de email não pode bloquear o motor de monitoramento | Envio síncrono — queue permite retry, backoff exponencial e tolerância a falhas |
| ADR-016 | 2026-02-18 | Log de notificação como tabela separada (log_notificacoes) | Rastreabilidade de cada envio, auditoria de quem foi notificado | Log em arquivo — tabela permite consulta, dashboard e auditoria |
| ADR-017 | 2026-02-18 | Bloqueio preventivo de contrato vencido (modo IRREGULAR) | Forçar ação administrativa — impedir que contratos fiquem vencidos sem tratamento | Apenas alerta visual — bloqueio de aditivo retroativo sem justificativa adiciona pressão operacional |
| ADR-018 | 2026-02-18 | Prioridade de alerta automática por proximidade (>30d/≤30d/≤7d) | Reduzir carga cognitiva do gestor — cores e prioridades devem ser automáticas | Prioridade manual — automática é consistente, sem dependência de ação humana |
| ADR-019 | 2026-02-18 | Dashboard com dados pré-agregados em tabela dedicada (dashboard_agregados) | Performance <2s exige dados pré-calculados, não queries em tempo real | Materialized views MySQL (não suporta nativamente), queries otimizadas com índices (lento em volume) |
| ADR-020 | 2026-02-18 | Cache Redis por município com TTL 24h para dados do dashboard | Reduzir carga no banco e garantir resposta rápida do painel executivo | Cache em arquivo (mais lento), sem cache com queries diretas (impacta performance) |
| ADR-021 | 2026-02-18 | Agregação noturna via Scheduled Command (AgregarDashboardCommand) | Processamento pesado fora do horário comercial para não impactar usuários | Queue job (menos previsível), trigger no banco (acoplamento excessivo) |
| ADR-022 | 2026-02-18 | Score de Gestão Contratual como nota 0-100 | Diferencial competitivo — permite dizer "município nota 82/100" em reuniões | Semáforo simples (menos granular), sem score (perde diferencial estratégico) |
| ADR-023 | 2026-02-18 | Painel de contratos essenciais separado no dashboard | Contratos de serviços vitais (merenda, transporte) precisam de destaque especial para o prefeito | Mesma lista com filtro (menos visibilidade), badge na listagem geral (perde impacto) |
| ADR-024 | 2026-02-18 | DashboardService centraliza toda lógica de agregação e consulta do painel | Lógica complexa de cálculos de indicadores não deve ficar no controller | Queries no controller (anti-pattern), repository pattern (overengineering neste caso) |
| ADR-025 | 2026-02-18 | TipoAditivo expandido de 4 para 7 valores (+ reequilibrio, alteracao_clausula, misto) | Necessidade de representar casos reais de aditamento municipal — reequilíbrio econômico-financeiro é comum em contratos de longa duração | Criar entidade separada para reequilíbrio — Enum mais simples e consistente com padrão do projeto |
| ADR-026 | 2026-02-18 | valor_acrescimo e valor_supressao como campos separados (substituindo valor_aditivo) | Tipos mistos precisam de ambos os valores; clareza no UI; cálculo de percentual acumulado exige separação | Manter valor_aditivo com sinal (positivo/negativo) — campos separados são mais expressivos e evitam confusão em aditivos tipo misto |
| ADR-027 | 2026-02-18 | Limites legais configuráveis em tabela `configuracoes_limite_aditivo` | Percentuais legais variam por tipo de contrato e podem mudar por decisão administrativa | Hardcoded no código — tabela permite configuração sem deploy; valores padrão via seeder |
| ADR-028 | 2026-02-18 | Critérios de risco de aditivos integrados ao score_risco existente (não score separado) | Aditivos frequentes ou com alto percentual acumulado aumentam o risco do contrato | Score separado para aditivos — integração ao score existente evita overengineering e mantém classificação única |
| ADR-029 | 2026-02-18 | Lógica de reequilíbrio mantida em AditivoService (método processarReequilibrio()) — sem ReequilibrioService | Reequilíbrio é um tipo de aditivo, não uma entidade distinta; a lógica é similar ao fluxo de aditivo de valor | ReequilibrioService separado — overengineering sem uso concreto imediato |
| ADR-030 | 2026-02-18 | historico_contrato (sugerida) descartada — usar historico_alteracoes existente (ADR-009) | Tabela polimórfica já cobre o caso de uso; criar tabela dedicada seria retrabalho e violaria ADR-009 | Tabela separada historico_contrato — viola princípio de não retrabalho |
| ADR-031 | 2026-02-18 | numero_sequencial calculado via MAX()+1 por contrato no momento da criação | Simplicidade de implementação sem dependência de sequence de banco — MySQL não suporta sequence nativo | Sequence de banco, UUID — MAX+1 é suficiente dado o volume esperado de aditivos por contrato |
| ADR-032 | 2026-02-18 | Limite de upload aumentado para 20MB por arquivo (de 10MB) | Documentos contratuais completos (contratos grandes, plantas de obras) frequentemente ultrapassam 10MB. A nova especificação de domínio define 20MB | Manter 10MB (insuficiente para casos reais) — 20MB cobre a maioria dos documentos sem risco de sobrecarga |
| ADR-033 | 2026-02-18 | Estrutura de storage isolada por contrato e tipo: `documentos/contratos/{contrato_id}/{tipo_documento}/` | Facilita listagem por tipo, isolamento entre contratos e eventual migração para S3 sem reorganização | Estrutura plana `documentos/{entidade}/{id}/{arquivo}` (anterior) — nova estrutura é mais granular e organizada |
| ADR-034 | 2026-02-18 | Versionamento por campo `versao` + `is_versao_atual` (sem tabela separada de versões) | Simplicidade — a entidade Documento já suporta múltiplos registros do mesmo tipo. Campo booleano `is_versao_atual` filtra a versão ativa | Tabela separada document_versions — overengineering; o modelo polimórfico já acomoda o histórico |
| ADR-035 | 2026-02-18 | Log de acesso a documentos em tabela separada `log_acesso_documentos` (não na historico_alteracoes) | Volume alto de eventos de acesso (download, visualização) poluiria o audit trail geral. Tabela dedicada permite consultas específicas e índices otimizados | Usar historico_alteracoes existente — mistura semântica inadequada; acesso a documento não é "alteração de entidade" |
| ADR-036 | 2026-02-18 | Completude documental como campo calculado no Model Contrato (accessor ou campo cacheado via Observer) | Dado derivado simples — pode ser calculado via accessor do Eloquent ou campo cacheado atualizado pelo DocumentoObserver. Sem necessidade de tabela extra | Tabela dedicada de completude — overengineering sem uso concreto adicional |
| ADR-037 | 2026-02-18 | OCR e busca full-text em PDF classificados como Fase 2 (não implementar em V1) | Tecnologias adicionais (Tesseract, ElasticSearch, microserviço) aumentariam significativamente a complexidade do stack sem valor imediato para a V1 | Implementar OCR em V1 — aumenta dependências e prazo sem uso concreto no lançamento |
| ADR-038 | 2026-02-18 | Score de risco expandido com 5 categorias (vencimento, financeiro, documental, jurídico, operacional) — campo único `score_risco` no Contrato | Módulo 6 exige classificação de risco mais granular com 5 categorias e subcritérios detalhados. Expandir o score_risco existente mantém campo único e evita duplicação. Critérios documentais granulares (RN-139) substituem o critério binário `sem_documento` existente | Score separado para o painel de risco — dois scores coexistiriam, complexidade desnecessária |
| ADR-039 | 2026-02-18 | Painel de Risco como página dedicada (`/painel-risco`) com resumo no Dashboard Executivo | Módulo 6 é o grande diferencial estratégico do sistema — merece visibilidade própria e destaque no menu lateral. Dashboard Executivo mantém Bloco 2 (resumo de risco) com link "Ver detalhes" para o Painel completo | Tudo dentro do Dashboard Executivo — perde destaque e sobrecarrega uma única página |
| ADR-040 | 2026-02-18 | PainelRiscoService dedicado (não expandir RiscoService) | RiscoService calcula o score por contrato individual. PainelRiscoService agrega indicadores do painel, ranking, mapa por secretaria e relatório TCE — responsabilidades distintas (SRP) | Expandir RiscoService — mistura cálculo unitário com agregação de indicadores, viola separação de responsabilidades |
| ADR-041 | 2026-02-18 | WhatsApp institucional como Fase 2 (não implementar em V1) | Similar ao OCR (ADR-037). API WhatsApp Business adiciona dependência externa e complexidade sem valor imediato para V1. V1 mantém canais email + sistema | Incluir WhatsApp em V1 — complexidade e custo de API sem necessidade imediata |
| ADR-042 | 2026-02-18 | Multi-tenant com banco isolado por prefeitura (database-per-tenant) | Segurança jurídica e isolamento político — dados de cada prefeitura em banco separado. Banco central/master para gestão de tenants. Estratégia pensada para SaaS nacional | tenant_id em tabela única — menos seguro juridicamente, risco de vazamento entre prefeituras |
| ADR-043 | 2026-02-18 | Armazenamento de arquivos em S3-compatible (MinIO dev / AWS S3 prod) | Nunca salvar arquivos no filesystem direto — escalabilidade e portabilidade. Bucket/pasta isolada por tenant | Storage local com links simbólicos — não escala, não permite multi-servidor |
| ADR-044 | 2026-02-18 | Senhas com Argon2id (driver padrão do Laravel) | Segurança de acesso — Argon2id é resistente a ataques de GPU e side-channel | bcrypt (padrão anterior) — Argon2id é mais moderno e recomendado |
| ADR-045 | 2026-02-18 | MFA opcional para usuários admin/gestor (TOTP) | Requisito de segurança para venda a prefeituras — reduz risco de acesso indevido | MFA obrigatório — impacta UX para municípios menores; sem MFA — insuficiente para vendas |
| ADR-046 | 2026-02-18 | Bloqueio de login após 5 tentativas com cooldown 15min | Proteção contra brute force — logs de login em tabela dedicada | Sem bloqueio — vulnerável; CAPTCHA — menos amigável |
| ADR-047 | 2026-02-18 | Hash SHA-256 de integridade para documentos contratuais | Proteção contra alegação de adulteração — hash gerado no upload e armazenado junto ao documento | MD5 — vulnerável a colisões; sem hash — sem prova de integridade |
| ADR-048 | 2026-02-18 | Logs de login em tabela dedicada `login_logs` | Rastreabilidade de acessos — requisito LGPD e segurança para venda a órgãos públicos | Log em arquivo — difícil consulta e auditoria |
| ADR-049 | 2026-02-18 | Sessão com expiração automática (SESSION_LIFETIME configurável, padrão 120min) | Segurança de acesso — sessões não podem permanecer ativas indefinidamente | Sem expiração — risco de sessões abandonadas em terminais públicos |
| ADR-050 | 2026-02-18 | RBAC com tabela `roles` dinâmica e 8 perfis padrão (substitui ADR-004) | Necessidade de segregação de função, controle interno, LGPD e aceitação institucional para venda a prefeituras. Admin pode criar perfis customizados | Enum PerfilUsuario fixo (não permite customização), manter 3 perfis antigos (insuficiente para segregação institucional) |
| ADR-051 | 2026-02-18 | Permissões granulares via tabela `permissions` com formato `recurso.acao` | Controle fino de acesso: `contrato.editar`, `aditivo.aprovar`. Necessário para auditoria e conformidade institucional | Middleware simples por perfil — não permite controle granular por ação e recurso |
| ADR-052 | 2026-02-18 | Workflow de aprovação 5 etapas para aditivos (V1) | Segregação de função obrigatória em aditivos: Gestor→Secretário→Jurídico→Controladoria→Homologação. Nenhum perfil aprova sozinho | Sem workflow — concentra decisão em perfil único, risco institucional de fraude |
| ADR-053 | 2026-02-18 | Permissões temporárias com `expires_at` na tabela `user_permissions` (V1) | Necessidade de substituições durante férias sem alterar perfil base. Job diário revoga automaticamente | Sem expiração — risco de acesso residual após fim da substituição |
| ADR-054 | 2026-02-18 | Permissão por secretaria via tabela `user_secretarias` | Secretário/Gestor/Fiscal acessam apenas contratos de secretarias vinculadas. Isolamento de acesso por órgão | Sem escopo por secretaria — todos veem tudo, viola segregação institucional |

| ADR-055 | 2026-02-19 | MFA obrigatório para perfis administrador_geral e controladoria (revisão parcial de ADR-045) | SaaS governamental com dados financeiros públicos exige segundo fator obrigatório para perfis com acesso irrestrito. Municípios de qualquer porte geralmente têm ao menos 1 administrador TI — custo de UX é aceitável para estes perfis | MFA obrigatório para todos (impacto em fiscal/gabinete sem ganho proporcional); manter totalmente opcional (insuficiente para dados governamentais) |
| ADR-056 | 2026-02-19 | Resolução de tenant via subdomínio DNS (subdomain-based) no middleware SetTenantConnection | Mecanismo resistente a falsificação — subdomínio controlado pelo DNS, não injetável por request. Necessário para segurança do multi-tenant | Header X-Tenant-ID (forjável), URL path (vaza dados em logs), JWT claim (inadequado para sessão web) |
| ADR-057 | 2026-02-19 | Estratégia de anonimização LGPD de dois planos: anonimizar tabelas operacionais, preservar tabelas de auditoria | Resolve conflito entre RN-213 e imutabilidade do historico_alteracoes (RN-037). Tabelas de auditoria documentam atos administrativos públicos — protegidas pelo art. 4o, III da LGPD | Anonimizar historico_alteracoes (viola imutabilidade e mandato legal de controle público); não implementar anonimização (viola LGPD) |
| ADR-058 | 2026-02-19 | Bucket S3 único com prefixo por tenant em V1, bucket dedicado por tenant em V2 | Simplicidade de provisionamento em V1 sem comprometer isolamento (prefixo validado no controller + IAM policy). Migração para bucket dedicado quando houver exigência contratual ou volume >50GB | Bucket dedicado desde V1 (sobrecarga de provisionamento), prefixo sem controle de acesso IAM (inseguro) |
| ADR-059 | 2026-02-19 | Controllers tenant em namespace `App\Http\Controllers\Tenant\` (nao `Admin\`) | Padrao estabelecido em IMP-013 (DashboardController) — manter consistencia evita retrabalho e confusao de namespace. Admin SaaS usa `AdminSaaS\`, tenant usa `Tenant\` | Namespace `Admin\` conforme estrutura-diretorios.md original — criaria inconsistencia com DashboardController existente |

### Como registrar:
1. Use ID sequencial (ADR-XXX)
2. Descreva a decisão de forma clara e objetiva
3. Contexto: por que essa decisão foi necessária?
4. Alternativas: o que mais foi considerado e por que não foi escolhido?

### Regras sobre ADRs:
- Uma vez registrada, uma ADR só pode ser alterada com justificativa explícita
- O Gestor de Memória (Agente 02) **bloqueia** ações que contradigam ADRs registradas
- Para reverter uma ADR, registre uma nova ADR que a substitua (nunca delete a original)
